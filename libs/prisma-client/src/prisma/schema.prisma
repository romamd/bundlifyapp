generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// STORE & AUTH
// ============================================

model Shop {
  id              String   @id @default(cuid())
  shopifyDomain   String   @unique @db.VarChar(255)
  accessToken     String   @db.Text
  shopifyStoreId  String?  @unique @db.VarChar(255)
  name            String?  @db.VarChar(255)
  email           String?  @db.VarChar(255)
  plan            PlanType @default(FREE)
  trialEndsAt     DateTime?
  installedAt     DateTime @default(now())
  uninstalledAt   DateTime?
  currency        String   @default("USD") @db.VarChar(3)

  defaultShippingCost   Decimal  @default(0)    @db.Decimal(10, 2)
  paymentProcessingPct  Decimal  @default(2.9)  @db.Decimal(5, 2)
  paymentProcessingFlat Decimal  @default(0.30) @db.Decimal(10, 2)

  products             Product[]
  bundles              Bundle[]
  bundleViews          BundleView[]
  settings             ShopSettings?
  webhookSubscriptions WebhookSubscription[]
  abTests              ABTest[]
  affinities           ProductAffinity[]
  integrations         Integration[]
  discountHistories    DiscountHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PlanType {
  FREE
  STARTER
  GROWTH
}

model ShopSettings {
  id     String @id @default(cuid())
  shopId String @unique
  shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  bundleWidgetEnabled   Boolean @default(true)
  checkoutUpsellEnabled Boolean @default(true)
  exitIntentEnabled     Boolean @default(false)

  autoGenerateBundles    Boolean @default(true)
  minBundleMarginPct     Decimal @default(15) @db.Decimal(5, 2)
  maxBundleProducts      Int     @default(4)
  includeDeadStock       Boolean @default(true)
  deadStockDaysThreshold Int     @default(60)

  showOnProductPage Boolean @default(true)
  showOnCartPage    Boolean @default(true)
  showAtCheckout    Boolean @default(true)
  showOnExitIntent  Boolean @default(false)

  cartDrawerEnabled       Boolean  @default(false)
  freeShippingThreshold   Decimal? @db.Decimal(10, 2)

  multiCurrencyEnabled Boolean  @default(false)
  displayCurrency      String?  @db.VarChar(3)

  widgetPrimaryColor       String  @default("#2563eb") @db.VarChar(9)
  widgetPrimaryColorHover  String  @default("#1d4ed8") @db.VarChar(9)
  widgetTextColor          String  @default("#111827") @db.VarChar(9)
  widgetCardBackground     String  @default("#ffffff") @db.VarChar(9)
  widgetBadgeBackground    String  @default("#dcfce7") @db.VarChar(9)
  widgetBadgeTextColor     String  @default("#166534") @db.VarChar(9)
  widgetBorderRadius       Int     @default(10)
  widgetButtonText         String  @default("Add Bundle to Cart") @db.VarChar(50)
  widgetLayout             String  @default("vertical") @db.VarChar(20)

  widgetCustomCss            String?  @db.Text
  widgetFontSize             Int      @default(14)
  widgetFontWeight           String   @default("normal") @db.VarChar(10)
  widgetBorderColor          String   @default("#e5e7eb") @db.VarChar(9)
  widgetSecondaryTextColor   String   @default("#6b7280") @db.VarChar(9)
  widgetShowSavings          Boolean  @default(true)
  widgetShowCompareAtPrice   Boolean  @default(true)
  widgetCardShadow           String   @default("subtle") @db.VarChar(10)

  widgetBlockTitleFontSize    Int    @default(18)
  widgetBlockTitleFontWeight  String @default("bold") @db.VarChar(10)
  widgetItemTitleFontSize     Int    @default(14)
  widgetItemTitleFontWeight   String @default("normal") @db.VarChar(10)
  widgetSubtitleFontSize      Int    @default(13)
  widgetSubtitleFontWeight    String @default("normal") @db.VarChar(10)
  widgetPriceFontSize         Int    @default(16)
  widgetPriceFontWeight       String @default("bold") @db.VarChar(10)
  widgetBadgeFontSize         Int    @default(12)
  widgetBadgeFontWeight       String @default("bold") @db.VarChar(10)
  widgetButtonFontSize        Int    @default(14)
  widgetButtonFontWeight      String @default("bold") @db.VarChar(10)

  widgetSelectedBgColor        String @default("#eff6ff") @db.VarChar(9)
  widgetBlockTitleColor        String @default("#111827") @db.VarChar(9)
  widgetTitleColor             String @default("#111827") @db.VarChar(9)
  widgetSubtitleColor          String @default("#6b7280") @db.VarChar(9)
  widgetPriceColor             String @default("#111827") @db.VarChar(9)
  widgetOriginalPriceColor     String @default("#9ca3af") @db.VarChar(9)
  widgetLabelBgColor           String @default("#e0e7ff") @db.VarChar(9)
  widgetLabelTextColor         String @default("#3730a3") @db.VarChar(9)
  widgetButtonTextColor        String @default("#ffffff") @db.VarChar(9)
  widgetSavingsBadgeBgColor    String @default("#dcfce7") @db.VarChar(9)
  widgetSavingsBadgeTextColor  String @default("#166534") @db.VarChar(9)
  widgetCardHoverBgColor       String @default("#f9fafb") @db.VarChar(9)

  // Gift element colors
  widgetGiftBgColor            String @default("#fef9c3") @db.VarChar(9)
  widgetGiftTextColor          String @default("#854d0e") @db.VarChar(9)
  widgetGiftSelectedBgColor    String @default("#fef08a") @db.VarChar(9)
  widgetGiftSelectedTextColor  String @default("#713f12") @db.VarChar(9)

  // Upsell element colors
  widgetUpsellBgColor            String @default("#f0fdf4") @db.VarChar(9)
  widgetUpsellTextColor          String @default("#166534") @db.VarChar(9)
  widgetUpsellSelectedBgColor    String @default("#dcfce7") @db.VarChar(9)
  widgetUpsellSelectedTextColor  String @default("#14532d") @db.VarChar(9)

  // Missing typography groups
  widgetLabelFontSize       Int    @default(11)
  widgetLabelFontWeight     String @default("bold") @db.VarChar(10)
  widgetGiftFontSize        Int    @default(13)
  widgetGiftFontWeight      String @default("normal") @db.VarChar(10)
  widgetUpsellFontSize      Int    @default(13)
  widgetUpsellFontWeight    String @default("normal") @db.VarChar(10)
  widgetUnitLabelFontSize   Int    @default(13)
  widgetUnitLabelFontWeight String @default("bold") @db.VarChar(10)

  // Spacing
  widgetSpacing Int @default(12)

  stickyBarEnabled         Boolean @default(false)
  stickyBarBgColor         String  @default("#ffffff") @db.VarChar(9)
  stickyBarTextColor       String  @default("#111827") @db.VarChar(9)
  stickyBarButtonBgColor   String  @default("#2563eb") @db.VarChar(9)
  stickyBarButtonTextColor String  @default("#ffffff") @db.VarChar(9)
  stickyBarButtonText        String @default("Choose Bundle") @db.VarChar(100)
  stickyBarTitleFontSize     Int    @default(14)
  stickyBarTitleFontWeight   String @default("normal") @db.VarChar(10)
  stickyBarButtonFontSize    Int    @default(14)
  stickyBarButtonFontWeight  String @default("bold") @db.VarChar(10)
  stickyBarButtonPadding     Int    @default(15)
  stickyBarButtonBorderRadius Int   @default(8)

  cartTimerMinutes  Int    @default(0)
  cartTimerText     String @default("Your cart will expire in {{timer}}") @db.VarChar(255)

  priceRoundingEnabled   Boolean @default(false)
  updateThemePrice       Boolean @default(false)
  themePriceMode         String  @default("per_item") @db.VarChar(20)
  excludeB2B             Boolean @default(false)
  discountOnlyViaWidget  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// PRODUCTS & COSTS
// ============================================

model Product {
  id               String  @id @default(cuid())
  shopId           String
  shop             Shop    @relation(fields: [shopId], references: [id], onDelete: Cascade)

  shopifyProductId String  @db.VarChar(255)
  shopifyVariantId String? @db.VarChar(255)
  title            String  @db.VarChar(500)
  variantTitle     String? @db.VarChar(500)
  sku              String? @db.VarChar(255)
  price            Decimal @db.Decimal(10, 2)
  compareAtPrice   Decimal? @db.Decimal(10, 2)

  cogs            Decimal? @db.Decimal(10, 2)
  shippingCost    Decimal? @db.Decimal(10, 2)
  additionalCosts Decimal? @db.Decimal(10, 2)

  contributionMargin    Decimal? @db.Decimal(10, 2)
  contributionMarginPct Decimal? @db.Decimal(5, 2)

  inventoryQuantity Int      @default(0)
  inventoryItemId   String?  @db.VarChar(255)
  avgDailySales     Decimal  @default(0) @db.Decimal(10, 4)
  lastSoldAt        DateTime?
  daysWithoutSale   Int      @default(0)
  isDeadStock       Boolean  @default(false)

  shopifyUpdatedAt DateTime?
  lastSyncedAt     DateTime?
  imageUrl         String?       @db.Text
  status           ProductStatus @default(ACTIVE)

  bundleItems    BundleItem[]
  bundleUpsells  BundleUpsell[]
  giftTiers      GiftTier[]
  affinitiesA    ProductAffinity[] @relation("AffinityProductA")
  affinitiesB  ProductAffinity[] @relation("AffinityProductB")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([shopId, shopifyProductId, shopifyVariantId])
  @@index([shopId, isDeadStock])
  @@index([shopId, contributionMarginPct])
  @@index([shopId, avgDailySales])
}

enum ProductStatus {
  ACTIVE
  DRAFT
  ARCHIVED
}

// ============================================
// BUNDLES
// ============================================

model Bundle {
  id     String       @id @default(cuid())
  shopId String
  shop   Shop         @relation(fields: [shopId], references: [id], onDelete: Cascade)

  name   String       @db.VarChar(255)
  slug   String       @db.VarChar(255)
  type   BundleType
  status BundleStatus @default(DRAFT)
  source BundleSource @default(AUTO)

  abTestId String?

  bundlePrice     Decimal      @db.Decimal(10, 2)
  individualTotal Decimal      @db.Decimal(10, 2)
  discountPct     Decimal      @db.Decimal(5, 2)
  discountType    DiscountType @default(PERCENTAGE)

  totalCogs             Decimal? @db.Decimal(10, 2)
  totalShippingCost     Decimal? @db.Decimal(10, 2)
  processingFee         Decimal? @db.Decimal(10, 2)
  contributionMargin    Decimal? @db.Decimal(10, 2)
  contributionMarginPct Decimal? @db.Decimal(5, 2)

  displayPriority Int         @default(0)
  triggerType     TriggerType @default(PRODUCT_PAGE)
  minCartValue    Decimal?    @db.Decimal(10, 2)
  maxCartValue    Decimal?    @db.Decimal(10, 2)

  maxRedemptions     Int?
  currentRedemptions Int      @default(0)
  startsAt           DateTime?
  endsAt             DateTime?

  bogoGetQuantity    Int?
  bogoGetDiscountPct Decimal? @db.Decimal(5, 2)

  giftsEnabled            Boolean @default(false)
  giftsTitle              String  @default("Free gifts with your order") @db.VarChar(255)
  giftsSubtitle           String? @db.VarChar(255)
  giftsLayout             String  @default("vertical") @db.VarChar(20)
  giftsHideUntilUnlocked  Boolean @default(false)
  giftsShowLockedLabels   Boolean @default(true)

  countdownEnabled   Boolean  @default(false)
  countdownType      String   @default("fixed") @db.VarChar(20)
  countdownDuration  Int?
  countdownEndDate   DateTime?
  countdownTitle     String?  @db.VarChar(255)
  countdownBgColor          String   @default("#111827") @db.VarChar(9)
  countdownTextColor        String   @default("#ffffff") @db.VarChar(9)
  countdownTitleFontSize    Int?
  countdownTitleFontWeight  String?  @db.VarChar(10)
  countdownTitleAlignment   String   @default("center") @db.VarChar(10)

  customCss      String? @db.Text
  translations   String? @db.Text

  lowStockAlertEnabled Boolean @default(false)
  skipToCheckout       Boolean @default(false)

  items            BundleItem[]
  upsells          BundleUpsell[]
  volumeTiers      VolumeTier[]
  views            BundleView[]
  displayRules     BundleDisplayRule[]
  abTests          ABTest[]
  discountHistory  DiscountHistory[]
  giftTiers        GiftTier[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shopId, status, triggerType])
  @@index([shopId, contributionMarginPct])
}

model BundleDisplayRule {
  id         String            @id @default(cuid())
  bundleId   String
  bundle     Bundle            @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  targetType DisplayRuleTarget
  targetId   String            @db.VarChar(255)

  @@unique([bundleId, targetType, targetId])
  @@index([targetType, targetId])
}

enum DisplayRuleTarget {
  PRODUCT
  COLLECTION
}

enum BundleType {
  FIXED
  MIX_MATCH
  VOLUME
  CROSS_SELL
  DEAD_STOCK
  BOGO
  COLLECTION
}

enum BundleStatus {
  DRAFT
  ACTIVE
  PAUSED
  EXPIRED
  ARCHIVED
}

enum BundleSource {
  AUTO
  MANUAL
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum TriggerType {
  PRODUCT_PAGE
  CART_PAGE
  CHECKOUT
  EXIT_INTENT
  POST_PURCHASE
}

model BundleItem {
  id        String  @id @default(cuid())
  bundleId  String
  bundle    Bundle  @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  quantity    Int     @default(1)
  isAnchor    Boolean @default(false)
  isDeadStock Boolean @default(false)
  sortOrder   Int     @default(0)

  @@unique([bundleId, productId])
}

model BundleUpsell {
  id       String @id @default(cuid())
  bundleId String
  bundle   Bundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  discountType  String  @default("PERCENTAGE") @db.VarChar(20)
  discountValue Decimal @default(0) @db.Decimal(5, 2)

  title            String  @default("{{product}}") @db.VarChar(255)
  subtitle         String? @db.VarChar(255)
  selectedByDefault Boolean @default(false)
  matchQuantity    Boolean @default(false)
  sortOrder        Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bundleId])
}

model VolumeTier {
  id           String       @id @default(cuid())
  bundleId     String
  bundle       Bundle       @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  minQuantity  Int
  maxQuantity  Int?
  discountPct  Decimal      @db.Decimal(5, 2)
  discountType DiscountType @default(PERCENTAGE)
  pricePerUnit Decimal?     @db.Decimal(10, 2)
  label        String?      @db.VarChar(50)

  @@unique([bundleId, minQuantity])
  @@index([bundleId])
}

model GiftTier {
  id       String @id @default(cuid())
  bundleId String
  bundle   Bundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  giftType       String  @default("FREE_GIFT") @db.VarChar(20)
  unlockQuantity Int     @default(1)
  label          String? @db.VarChar(255)
  lockedTitle    String  @default("Locked") @db.VarChar(255)
  imageUrl       String? @db.Text
  sortOrder      Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bundleId])
}

// ============================================
// ANALYTICS
// ============================================

model BundleView {
  id       String @id @default(cuid())
  shopId   String
  shop     Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)
  bundleId String
  bundle   Bundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  event     BundleEvent
  sessionId String?     @db.VarChar(255)

  abTestId  String?     @db.VarChar(255)
  abVariant String?     @db.VarChar(10)

  triggerType TriggerType
  pageUrl     String?     @db.Text
  cartValue   Decimal?    @db.Decimal(10, 2)

  orderId String?  @db.VarChar(255)
  revenue Decimal? @db.Decimal(10, 2)
  margin  Decimal? @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  @@index([shopId, bundleId, event, createdAt])
  @@index([shopId, createdAt])
}

enum BundleEvent {
  VIEWED
  CLICKED
  ADDED_TO_CART
  PURCHASED
  DISMISSED
}

model WebhookSubscription {
  id        String @id @default(cuid())
  shopId    String
  shop      Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)
  topic     String @db.VarChar(255)
  webhookId String @unique @db.VarChar(255)

  createdAt DateTime @default(now())

  @@unique([shopId, topic])
}

// ============================================
// A/B TESTING
// ============================================

model ABTest {
  id       String       @id @default(cuid())
  shopId   String
  shop     Shop         @relation(fields: [shopId], references: [id], onDelete: Cascade)
  bundleId String
  bundle   Bundle       @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  name   String       @db.VarChar(255)
  status ABTestStatus @default(DRAFT)

  controlDiscountPct Decimal @db.Decimal(5, 2)
  variantDiscountPct Decimal @db.Decimal(5, 2)

  controlImpressions  Int @default(0)
  controlConversions  Int @default(0)
  controlRevenue      Decimal @default(0) @db.Decimal(10, 2)
  variantImpressions  Int @default(0)
  variantConversions  Int @default(0)
  variantRevenue      Decimal @default(0) @db.Decimal(10, 2)

  startedAt       DateTime?
  endedAt         DateTime?
  winnerVariant   String?   @db.VarChar(10)
  confidenceLevel Decimal?  @db.Decimal(5, 4)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shopId, status])
  @@index([bundleId])
}

enum ABTestStatus {
  DRAFT
  RUNNING
  COMPLETED
}

// ============================================
// PRODUCT AFFINITY (Frequently Bought Together)
// ============================================

model ProductAffinity {
  id     String @id @default(cuid())
  shopId String
  shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  productAId String
  productA   Product @relation("AffinityProductA", fields: [productAId], references: [id], onDelete: Cascade)
  productBId String
  productB   Product @relation("AffinityProductB", fields: [productBId], references: [id], onDelete: Cascade)

  coOccurrences    Int     @default(0)
  affinityScore    Decimal @default(0) @db.Decimal(10, 6)
  lastCalculatedAt DateTime @default(now())

  @@unique([shopId, productAId, productBId])
  @@index([shopId, affinityScore])
}

// ============================================
// MULTI-CURRENCY
// ============================================

model ExchangeRate {
  id             String @id @default(cuid())
  baseCurrency   String @db.VarChar(3)
  targetCurrency String @db.VarChar(3)
  rate           Decimal @db.Decimal(20, 10)
  source         String  @default("ecb") @db.VarChar(50)
  fetchedAt      DateTime @default(now())

  @@unique([baseCurrency, targetCurrency])
}

// ============================================
// INTEGRATIONS (QuickBooks / Xero)
// ============================================

model Integration {
  id       String            @id @default(cuid())
  shopId   String
  shop     Shop              @relation(fields: [shopId], references: [id], onDelete: Cascade)
  provider IntegrationProvider

  accessToken    String  @db.Text
  refreshToken   String? @db.Text
  tokenExpiresAt DateTime?
  externalId     String? @db.VarChar(255)

  lastSyncedAt DateTime?
  status       IntegrationStatus @default(CONNECTED)
  syncErrors   String?           @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([shopId, provider])
}

enum IntegrationProvider {
  QUICKBOOKS
  XERO
}

enum IntegrationStatus {
  CONNECTED
  DISCONNECTED
  ERROR
}

// ============================================
// DISCOUNT HISTORY (Smart Optimization)
// ============================================

model DiscountHistory {
  id       String @id @default(cuid())
  bundleId String
  bundle   Bundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  shopId   String
  shop     Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  previousDiscountPct Decimal @db.Decimal(5, 2)
  newDiscountPct      Decimal @db.Decimal(5, 2)
  reason              String  @db.VarChar(100)

  appliedAt DateTime @default(now())

  @@index([bundleId, appliedAt])
  @@index([shopId])
}
